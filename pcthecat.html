<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>MushRush ‚Äî Early Access (Polished) ‚Äî with Sign-in Modal</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg-900:#05020a;
    --panel:#0b0910;
    --muted:rgba(255,255,255,0.92);
    --muted-2:rgba(255,255,255,0.62);
    --purple-800:#3b0f78;
    --purple-700:#5b21a6;
    --purple-500:#8b5cf6;
    --purple-300:#c6a6ff;
    --accent:#ff6fcf;
    --success:#22c55e;
    --glass:rgba(255,255,255,0.04);
    --card-radius:14px;
    --shadow-lg: 0 20px 50px rgba(6,8,20,0.7);
    --focus: rgba(139,92,246,0.16);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#03010a 0%, #06020b 100%);color:#eef2ff;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
  body::before{content:'';position:fixed;inset:0;background-image:radial-gradient(rgba(255,255,255,0.004) 1px, transparent 1px);background-size:8px 8px;mix-blend-mode:overlay;opacity:.6;pointer-events:none}

  /* stage + panels (copied from original, slightly trimmed) */
  .stage-wrap{width:1280px;height:760px;margin:0 auto;transform-origin:top center;display:flex;align-items:center;justify-content:center}
  .stage{width:1240px;height:720px;padding:22px;box-sizing:border-box;display:grid;grid-template-columns:1fr 480px;gap:28px;border-radius:18px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.006));border:1px solid var(--glass);box-shadow:var(--shadow-lg)}
  .left{display:flex;flex-direction:column;gap:14px;padding:10px}
  .header{display:flex;align-items:center;gap:12px}
  .logo{width:56px;height:46px;border-radius:12px;background:linear-gradient(135deg,var(--purple-700),var(--purple-500));display:flex;align-items:center;justify-content:center;font-weight:800}
  .title{font-weight:700}
  .subtitle{font-size:13px;color:var(--muted-2)}
  .h1{font-family:Space Mono,monospace;font-weight:800;letter-spacing:1px;color:var(--purple-300);font-size:28px}
  .lead{color:var(--muted);max-width:640px}
  .input{flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-weight:600}
  .btn-task{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--purple-700),var(--purple-500));color:white;font-weight:800;cursor:pointer;box-shadow:0 8px 20px rgba(91,33,166,0.12)}
  .btn-task.small{padding:8px 12px;font-weight:700}
  .btn-cta-primary{padding:12px 16px;border-radius:12px;border:0;background:linear-gradient(90deg,var(--purple-700),var(--purple-300));color:white;font-weight:900;cursor:pointer;box-shadow:0 14px 36px rgba(91,33,166,0.12)}
  .btn-cta-secondary{padding:12px 16px;border-radius:12px;border:2px solid rgba(255,255,255,0.06);background:transparent;color:var(--purple-300);font-weight:900;cursor:pointer}

  /* icon btns */
  .icon-btn{width:42px;height:42px;border-radius:10px;display:inline-flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);color: #fff;cursor:pointer}
  .icon-btn.download{background:linear-gradient(90deg,#5b21a6,#8b5cf6);border:0}
  .icon-btn.close{background:linear-gradient(180deg, rgba(255,80,80,0.06), rgba(255,40,40,0.02));border-color: rgba(255,80,80,0.10)}

  /* overlay & toast & confetti */
  .overlay {position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg, rgba(1,1,2,0.6), rgba(1,1,2,0.75));backdrop-filter:blur(6px);z-index:60}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:36px;background:linear-gradient(90deg, rgba(0,0,0,0.45), rgba(0,0,0,0.35));padding:10px 14px;border-radius:10px;color:white;z-index:70;opacity:0;transition:opacity .18s ease}

  /* ------------------------- Modal styles ------------------------- */
  .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:200;opacity:0;pointer-events:none;transition:opacity .18s ease}
  .modal-overlay.open{opacity:1;pointer-events:auto}
  .modal{width:420px;max-width:calc(100% - 48px);background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 24px 60px rgba(6,8,20,0.8);color:var(--muted)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
  .modal-title{font-weight:800;font-size:16px}
  .modal-tabs{display:flex;gap:8px;margin-bottom:14px}
  .tab{flex:1;padding:10px;border-radius:10px;text-align:center;cursor:pointer;font-weight:700;border:1px solid transparent}
  .tab[aria-selected="true"]{background:linear-gradient(90deg,var(--purple-700),var(--purple-500));color:white}
  .modal-body{display:flex;flex-direction:column;gap:10px}
  .form-row{display:flex;flex-direction:column;gap:6px}
  .form-row label{font-size:13px;color:var(--muted-2)}
  .form-row input{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit;font-weight:700}
  .form-actions{display:flex;gap:10px;align-items:center;margin-top:6px}
  .btn-primary{flex:1;padding:10px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--purple-700),var(--purple-500));color:white;font-weight:800;cursor:pointer}
  .btn-ghost{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted-2);cursor:pointer}
  .oauth-btn{display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;border:0;cursor:pointer;font-weight:800}
  .oauth-btn .icon{width:18px;height:18px;display:inline-block}
  .oauth-twitter{background:linear-gradient(90deg,#1d9bf0,#0c7adf);color:white}
  .helper{font-size:13px;color:var(--muted-2)}
  .error{color:#ff9aa2;font-weight:800;font-size:13px}
  .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,0.08);border-top-color:white;animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}

  @media (max-width:540px){
    .modal{width:92%}
    .stage{grid-template-columns:1fr}
    .stage-wrap{width:100%}
  }
</style>
</head>
<body>
  <!-- original page markup (kept intact) -->
  <div id="stageWrap" class="stage-wrap" aria-hidden="false">
    <div id="stage" class="stage" role="region" aria-label="MushRush early access">

      <div class="left panel">
        <div class="header">
          <div class="logo" aria-hidden="true">M</div>
          <div>
            <div class="title">MushRush ‚Äî Early Access</div>
            <div class="subtitle">Marketing landing ‚Ä¢ Share to climb the queue</div>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
            <!-- SIGN IN button: opens modal -->
            <button id="openSignIn" class="btn-task small" title="Sign in or sign up">Sign in</button>
            <button class="btn-task small" id="copyRef" title="Copy referral address">Copy ref</button>
          </div>
        </div>

        <div>
          <div class="h1">GET EARLY ACCESS</div>
          <div class="lead" style="margin-top:8px">Complete a few simple tasks and share your referral to move up the early access queue.</div>
        </div>

        <div class="ref-block">
          <div class="ref-required">Referral code/address is <strong>required</strong> to register</div>
          <div class="input-row">
            <input id="useRef" class="input" placeholder="Enter referral code or wallet address (required)" maxlength="80" aria-label="Referral code or address" />
            <button id="applyRef" class="btn-apply" title="Apply referral">Apply</button>
          </div>
          <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
            <div class="hint">Your referral:</div>
            <div style="font-weight:800;color:var(--purple-300)" id="myRefShort">RF-XXXX</div>
            <div class="hint" style="margin-left:6px;color:var(--muted-2)" id="myFullRef">0x...hidden</div>
          </div>
        </div>


<div class="tasks" id="tasks">
<div class="task-row" data-task="discord">
<div class="task-left"><span class="task-dot" id="dot-discord"></span><div class="task-label">Join our Discord</div></div>
<div><button class="btn-task" id="task-discord">Join</button></div>
</div>

<div class="task-row" data-task="share">
<div class="task-left"><span class="task-dot" id="dot-share"></span><div class="task-label">Share your referral card</div></div>
<div><button class="btn-task" id="task-share">Share</button></div>
</div>

<div class="task-row" data-task="follow">
<div class="task-left"><span class="task-dot" id="dot-follow"></span><div class="task-label">Follow us on X</div></div>
<div><button class="btn-task" id="task-follow">Follow</button></div>
</div>

<div class="progress" id="progressText">0 / 3 tasks completed</div>
</div>
        <div class="cta-row">
          <button id="registerBtn" class="btn-cta-primary" disabled>Register for Early Access</button>
          <button id="sharePrimary" class="btn-cta-secondary">Share on X</button>
        </div>
      </div>

      <div class="right" aria-live="polite">
        <div class="card" id="playerCard" role="region" aria-label="Player card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:900;color:var(--muted-2)">PLAYER CARD</div>
            <div style="display:flex;gap:10px">
              <button id="downloadBtn" class="icon-btn download" title="Download card" aria-label="Download card">...</button>
              <button id="closeBtn" class="icon-btn close" title="Close card" aria-label="Close card">...</button>
            </div>
          </div>

          <div class="image-frame" style="margin-top:14px">
            <div class="image-card"><img id="avatarImg" src="pc.avif" alt="player avatar" /></div>
          </div>

          <div class="card-meta">
            <div class="meta-left">ID: <span id="playerId">(hidden)</span></div>
            <div class="status" id="statusText">Not registered</div>
          </div>

        </div>
      </div>

    </div>
  </div>

  <canvas id="confetti" class="confetti-canvas" aria-hidden="true"></canvas>
  <div id="toast" class="toast" role="status" aria-live="polite">Copied to clipboard</div>

  <!-- SIGN IN / SIGN UP modal (hidden by default) -->
  <div id="authModalOverlay" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal" role="document" aria-labelledby="authTitle">
      <div class="modal-header">
        <div id="authTitle" class="modal-title">Sign in to MushRush</div>
        <button id="closeModal" class="icon-btn close" aria-label="Close authentication dialog">‚úï</button>
      </div>

      <div class="modal-tabs" role="tablist" aria-label="Authentication tabs">
        <div id="tabSignIn" class="tab" role="tab" tabindex="0" aria-selected="true">Sign in</div>
        <div id="tabSignUp" class="tab" role="tab" tabindex="0" aria-selected="false">Sign up</div>
      </div>

      <div class="modal-body">
        <!-- OAuth (Twitter/X) -->
        <button id="oauthTwitter" class="oauth-btn oauth-twitter" aria-label="Sign in with X">
          <span class="icon" aria-hidden="true">üê¶</span>
          <span>Continue with X</span>
        </button>

        <div style="text-align:center" class="helper">or use your email / username</div>

        <!-- SIGN IN form -->
        <form id="signInForm" class="auth-form" autocomplete="on">
          <div class="form-row">
            <label for="si-username">Email or username</label>
            <input id="si-username" name="username" type="text" inputmode="text" required />
          </div>
          <div class="form-row">
            <label for="si-password">Password</label>
            <input id="si-password" name="password" type="password" required />
          </div>
          <div id="si-error" class="error" role="status" aria-live="polite" style="display:none"></div>
          <div class="form-actions">
            <button id="si-submit" class="btn-primary" type="submit">Sign in</button>
            <button id="si-cancel" type="button" class="btn-ghost">Cancel</button>
          </div>
        </form>

        <!-- SIGN UP form (hidden initially) -->
        <form id="signUpForm" class="auth-form" autocomplete="on" style="display:none">
          <div class="form-row">
            <label for="su-username">Choose a username</label>
            <input id="su-username" name="username" type="text" inputmode="text" required />
          </div>
          <div class="form-row">
            <label for="su-email">Email</label>
            <input id="su-email" name="email" type="email" required />
          </div>
          <div class="form-row">
            <label for="su-password">Password</label>
            <input id="su-password" name="password" type="password" minlength="8" required />
          </div>
          <div class="form-row">
            <label for="su-password-confirm">Confirm password</label>
            <input id="su-password-confirm" name="passwordConfirm" type="password" minlength="8" required />
          </div>
          <div class="form-row">
            <label for="su-ref">Referral code (optional)</label>
            <input id="su-ref" name="ref" type="text" />
          </div>
          <div id="su-error" class="error" role="status" aria-live="polite" style="display:none"></div>
          <div class="form-actions">
            <button id="su-submit" class="btn-primary" type="submit">Create account</button>
            <button id="su-cancel" type="button" class="btn-ghost">Cancel</button>
          </div>
        </form>

      </div>
    </div>
  </div>

<script>
// Auth modal + OAuth popup + basic form handling + accessibility helpers
(function(){
  const overlay = document.getElementById('authModalOverlay');
  const openBtn = document.getElementById('openSignIn');
  const closeBtn = document.getElementById('closeModal');
  const tabSignIn = document.getElementById('tabSignIn');
  const tabSignUp = document.getElementById('tabSignUp');
  const signInForm = document.getElementById('signInForm');
  const signUpForm = document.getElementById('signUpForm');
  const siError = document.getElementById('si-error');
  const suError = document.getElementById('su-error');
  const oauthTwitter = document.getElementById('oauthTwitter');
  const siCancel = document.getElementById('si-cancel');
  const suCancel = document.getElementById('su-cancel');
  const suRef = document.getElementById('su-ref');

  // expose applyLoginState (used elsewhere in your page) -- keep it global
  window.applyLoginState = function(user){
    // update header button to show logged-in user
    openBtn.textContent = 'Signed in: @' + (user.username || user.name || user.id);
    openBtn.classList.add('done');
    document.getElementById('registerBtn').disabled = false;
    closeModal();
  };

  // Initialize referral code into signup if available
  (function initRef(){
    const fullRefEl = document.getElementById('myFullRef');
    if(fullRefEl && fullRefEl.dataset && fullRefEl.dataset.full){
      suRef.value = fullRefEl.dataset.full;
    }
  })();

  // Open / close modal with accessible focus management
  let lastFocused = null;
  function openModal(){
    lastFocused = document.activeElement;
    overlay.classList.add('open');
    overlay.setAttribute('aria-hidden','false');
    tabSignIn.focus();
    trapFocus(overlay);
  }
  function closeModal(){
    overlay.classList.remove('open');
    overlay.setAttribute('aria-hidden','true');
    releaseFocusTrap();
    if(lastFocused) lastFocused.focus();
  }

  openBtn.addEventListener('click', openModal);
  closeBtn.addEventListener('click', closeModal);
  siCancel.addEventListener('click', closeModal);
  suCancel.addEventListener('click', closeModal);

  // switch tabs
  function showTab(which){
    if(which === 'signin'){
      tabSignIn.setAttribute('aria-selected','true');
      tabSignUp.setAttribute('aria-selected','false');
      signInForm.style.display = '';
      signUpForm.style.display = 'none';
      document.getElementById('authTitle').textContent = 'Sign in to MushRush';
    } else {
      tabSignIn.setAttribute('aria-selected','false');
      tabSignUp.setAttribute('aria-selected','true');
      signInForm.style.display = 'none';
      signUpForm.style.display = '';
      document.getElementById('authTitle').textContent = 'Create your MushRush account';
    }
  }
  tabSignIn.addEventListener('click', ()=> showTab('signin'));
  tabSignUp.addEventListener('click', ()=> showTab('signup'));
  tabSignIn.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') showTab('signin'); });
  tabSignUp.addEventListener('keydown', (e)=> { if(e.key==='Enter' || e.key===' ') showTab('signup'); });

  // Simple form helpers
  function setFormBusy(form, busy){
    const btn = form.querySelector('button[type="submit"]');
    if(busy){
      btn.dataset.orig = btn.textContent;
      btn.innerHTML = '<span class="spinner" aria-hidden="true"></span>'; 
      btn.disabled = true;
    } else {
      if(btn.dataset.orig) btn.textContent = btn.dataset.orig;
      btn.disabled = false;
    }
  }

  async function signIn(payload){
    // replace endpoint with your real backend
    try {
      setFormBusy(signInForm, true);
      const res = await fetch('/api/auth/signin', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if(res.ok && j.user){
        window.applyLoginState(j.user);
      } else {
        siError.style.display = '';
        siError.textContent = j.message || 'Sign in failed';
      }
    } catch(err){
      siError.style.display = '';
      siError.textContent = 'Network error';
      console.error(err);
    } finally { setFormBusy(signInForm, false); }
  }

  async function signUp(payload){
    try {
      setFormBusy(signUpForm, true);
      const res = await fetch('/api/auth/signup', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      const j = await res.json();
      if(res.ok && j.user){
        window.applyLoginState(j.user);
      } else {
        suError.style.display = '';
        suError.textContent = j.message || 'Sign up failed';
      }
    } catch(err){
      suError.style.display = '';
      suError.textContent = 'Network error';
      console.error(err);
    } finally { setFormBusy(signUpForm, false); }
  }

  signInForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    siError.style.display = 'none';
    const uname = document.getElementById('si-username').value.trim();
    const pwd = document.getElementById('si-password').value;
    if(!uname || !pwd){ siError.style.display = ''; siError.textContent = 'Please fill in all fields.'; return; }
    signIn({ username: uname, password: pwd });
  });

  signUpForm.addEventListener('submit', (e)=>{
    e.preventDefault();
    suError.style.display = 'none';
    const un = document.getElementById('su-username').value.trim();
    const mail = document.getElementById('su-email').value.trim();
    const pw = document.getElementById('su-password').value;
    const pw2 = document.getElementById('su-password-confirm').value;
    const ref = document.getElementById('su-ref').value.trim();
    if(!un || !mail || !pw || !pw2){ suError.style.display = ''; suError.textContent = 'Please fill in all fields.'; return; }
    if(pw !== pw2){ suError.style.display = ''; suError.textContent = 'Passwords do not match.'; return; }
    signUp({ username: un, email: mail, password: pw, ref });
  });

  // OAuth (X/Twitter) popup logic. Backend must support /auth/x/login and postMessage on success.
  oauthTwitter.addEventListener('click', ()=>{
    const popup = window.open('/auth/x/login','xlogin','width=600,height=700');
    if(!popup){ alert('Please allow popups for this site to sign in with X'); return; }

    // listen for postMessage from popup
    function onMsg(ev){
      // Accept messages only from same origin or that include the agreed shape
      if(!ev.data) return;
      if(ev.data.type === 'mushrush.x.auth'){
        window.removeEventListener('message', onMsg);
        if(ev.data.user){
          window.applyLoginState(ev.data.user);
        } else {
          alert('Authentication failed');
        }
      }
    }
    window.addEventListener('message', onMsg);

    // fallback: poll /api/me in short intervals in case popup does a server-side redirect + cookie
    const poll = setInterval(async ()=>{
      try{
        const r = await fetch('/api/me');
        const j = await r.json();
        if(j.logged){ clearInterval(poll); window.applyLoginState(j.user); }
      }catch(e){}
    }, 900);
  });

  // simple toast helper (reuse existing toast element)
  const toast = document.getElementById('toast');
  function showToast(text, ms=1800){ toast.textContent = text; toast.style.opacity = 1; setTimeout(()=>{ toast.style.opacity = 0; }, ms); }

  // Basic focus trap implementation
  let focusable = null;
  let firstFocusable = null;
  let lastFocusable = null;
  function trapFocus(container){
    focusable = Array.from(container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])')).filter(el => !el.disabled && el.offsetParent !== null);
    if(focusable.length === 0) return;
    firstFocusable = focusable[0];
    lastFocusable = focusable[focusable.length-1];
    container.addEventListener('keydown', handleTrap);
  }
  function releaseFocusTrap(){
    overlay.removeEventListener('keydown', handleTrap);
  }
  function handleTrap(e){
    if(e.key === 'Escape') return closeModal();
    if(e.key !== 'Tab') return;
    if(focusable.length === 0) return;
    if(e.shiftKey){ // shift + tab
      if(document.activeElement === firstFocusable){ e.preventDefault(); lastFocusable.focus(); }
    } else {
      if(document.activeElement === lastFocusable){ e.preventDefault(); firstFocusable.focus(); }
    }
  }

  // close modal by clicking outside
  overlay.addEventListener('click', (ev)=>{ if(ev.target === overlay) closeModal(); });

  // small utility: poll /api/me on page load to update state
  async function pollMe(){
    try{
      const r = await fetch('/api/me');
      const j = await r.json();
      if(j.logged) window.applyLoginState(j.user);
    }catch(e){}
  }
  pollMe();

})();
</script>

</body>
</html>
