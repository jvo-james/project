<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MushRush — On-Chain (Frontend)</title>

<!-- Ethers.js v5 CDN -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#05020a; --panel:#0b0910; --muted:rgba(255,255,255,0.72);
    --muted-2:rgba(255,255,255,0.38); --purple-700:#5b21a6; --purple-500:#8b5cf6;
    --accent:#ff6fcf; --card-radius:12px; --glass:rgba(255,255,255,0.03);
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,#03010a,#06020b);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:#eef2ff}
  .container{max-width:1100px;margin:28px auto;padding:22px;display:grid;grid-template-columns:1fr 380px;gap:20px}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:18px;border:1px solid var(--glass)}
  header{display:flex;align-items:center;gap:12px;margin-bottom:10px}
  .logo{width:54px;height:42px;border-radius:10px;background:linear-gradient(135deg,var(--purple-700),var(--purple-500));display:flex;align-items:center;justify-content:center;font-weight:800;font-family:Space Mono}
  h1{font-family:Space Mono;margin:0;font-size:20px;color:#c6a6ff}
  .muted{color:var(--muted-2);font-size:13px}
  .row{display:flex;gap:10px;align-items:center}
  .col{display:flex;flex-direction:column;gap:8px}
  input, select, button{font-family:inherit}
  input[type=text], select{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
  .btn{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,var(--purple-700),var(--purple-500));cursor:pointer;color:white;font-weight:700}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--purple-300)}
  .small{padding:8px 10px;font-size:14px}
  .stat{background:rgba(255,255,255,0.02);padding:10px;border-radius:8px}
  .right .card{height:100%}
  .section-title{font-weight:700;color:var(--muted);font-size:13px;margin-bottom:6px}

  /* inventory table */
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.03);font-size:13px}
  th{color:var(--muted-2)}
  .green{color:#7ee6a6}

  .footer-note{font-size:12px;color:var(--muted-2);margin-top:8px}
  .danger{color:#ff7a7a}
  .success{color:#7ee6a6}
  .center{display:flex;align-items:center;justify-content:center}
  .code{font-family:Space Mono;background:rgba(255,255,255,0.02);padding:6px;border-radius:6px}
  #toast{position:fixed;right:16px;bottom:16px;background:#111;border:1px solid rgba(255,255,255,0.03);padding:10px 12px;border-radius:10px;opacity:0;transition:opacity .2s;color:#fff}
</style>
</head>
<body>
  <div class="container">

    <!-- LEFT: main UI -->
    <div>
      <div class="card">
        <header>
          <div class="logo">M</div>
          <div>
            <h1>MushRush — On-chain Game</h1>
            <div class="muted">Early access frontend — interacts with your deployed contract</div>
          </div>
          <div style="margin-left:auto">
            <button id="connectBtn" class="btn small">Connect Wallet</button>
          </div>
        </header>

        <div style="display:flex;gap:12px;margin-bottom:12px">
          <div class="stat" style="flex:1">
            <div class="section-title">Connected</div>
            <div id="addrDisplay" class="muted">Not connected</div>
            <div id="refCodeLocal" class="code" style="margin-top:8px;display:inline-block"></div>
          </div>
          <div class="stat" style="width:180px">
            <div class="section-title">Network</div>
            <div id="networkName" class="muted">—</div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-bottom:12px">
          <div style="flex:1">
            <div class="section-title">Referral (required to register)</div>
            <div class="row">
              <input id="refInput" type="text" placeholder="Enter 6-char referral code or leave empty to use yours" maxlength="12" />
              <button id="applyRef" class="btn ghost small">Use</button>
            </div>
            <div class="footer-note">If you don't have one yet the app will propose a code once you connect.</div>
          </div>

          <div style="width:180px">
            <div class="section-title">Treasury</div>
            <!-- user's provided treasury address used below -->
            <div id="treasuryAddr" class="muted code">0x7f921fab847b06da6a0357e0e662a8ade212dbb7</div>
          </div>
        </div>

        <!-- Main actions -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px">
          <button id="registerBtn" class="btn" disabled>Register (pay fee)</button>
          <button id="claimBtn" class="btn ghost" disabled>Claim MUSH</button>

          <button id="upgradeBtn" class="btn" disabled>Upgrade Farm</button>
          <button id="swapBtn" class="btn ghost" disabled>Swap MON → MUSH</button>
        </div>

        <div style="display:flex;gap:12px;margin-top:6px">
          <div style="flex:1">
            <div class="section-title">Packs (Open on-chain)</div>
            <div class="row">
              <button id="openBasic" class="btn small">Open Basic (0.01 MON)</button>
              <button id="openPremium" class="btn small">Open Premium (0.05 MON)</button>
            </div>
            <div class="footer-note">Packs give randomized items. Results are emitted on-chain.</div>
          </div>

          <div style="width:220px">
            <div class="section-title">Player stats</div>
            <div class="muted">Power: <span id="playerPower">—</span></div>
            <div class="muted">Pending: <span id="pendingRewards">—</span></div>
            <div class="muted">Level: <span id="playerLevel">—</span></div>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0" />

        <div>
          <div class="section-title">Inventory</div>
          <div id="invArea">
            <table id="invTable">
              <thead><tr><th>Item ID</th><th>Power</th><th>Slot</th></tr></thead>
              <tbody id="invBody"><tr><td colspan="3" class="muted center">Not loaded</td></tr></tbody>
            </table>
          </div>
        </div>

        <div style="margin-top:12px" class="footer-note">
          Developer notes: this frontend expects a contract with the following methods (examples):
          <div style="font-family:Space Mono;margin-top:6px">register(bytes6) payable | claim() | openPack(uint256) payable | upgrade(uint256) payable | swapMonForMush() payable | pendingRewards(address) view | getInventory(address) view</div>
        </div>
      </div>
    </div>

    <!-- RIGHT: admin / debug / logs -->
    <div class="right">
      <div class="card">
        <div class="section-title">Config & Logs</div>

        <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:10px">
          <label class="muted">Game contract address</label>
          <input id="contractAddress" type="text" value="" placeholder="0x..." />
          <label class="muted">MUSH token address</label>
          <input id="mushAddress" type="text" value="" placeholder="0x..." />
          <div class="row" style="margin-top:6px">
            <button id="setAddresses" class="btn small">Use addresses</button>
            <button id="refreshBtn" class="btn ghost small">Refresh Data</button>
          </div>
        </div>

        <div class="section-title">Quick actions (dev)</div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <button id="showCodeBtn" class="btn small ghost">Show computed referral code</button>
          <button id="copyAddrBtn" class="btn small">Copy my address</button>
        </div>

        <div style="margin-top:12px">
          <div class="section-title">Realtime logs</div>
          <div id="logArea" style="height:260px;overflow:auto;background:rgba(0,0,0,0.12);padding:8px;border-radius:8px;font-family:monospace;font-size:13px"></div>
        </div>

      </div>
    </div>

  </div>

  <div id="toast">—</div>

<script>
// ---------------------- CONFIG (edit as needed) ----------------------
const TREASURY_ADDRESS = "0x7f921fab847b06da6a0357e0e662a8ade212dbb7"; // user's provided address (default)
const GAME_CONTRACT_ADDRESS = "";   // set in UI (must be deployed)
const MUSH_TOKEN_ADDRESS   = "";   // set in UI
// Minimal ABI used by this frontend. Make sure your on-chain contract exposes matching function names/types.
const GAME_ABI = [
  // views
  "function pendingRewards(address who) view returns (uint256)",
  "function getPlayerPower(address who) view returns (uint256)",
  "function getPlayerLevel(address who) view returns (uint256)",
  "function getInventory(address who) view returns (uint256[])",
  // actions
  "function register(bytes6 refCode) payable",
  "function claim()",
  "function openPack(uint256 packId) payable",
  "function upgrade(uint256 levels) payable",
  "function swapMonForMush() payable",
  // optional events
  "event Registered(address indexed player, bytes6 code, address indexed referrer)",
  "event Claimed(address indexed player, uint256 amount)",
  "event PackOpened(address indexed player, uint256 indexed packId, uint256 itemId)"
];
// ---------------------- END CONFIG ----------------------

let provider, signer, userAddr;
let gameContract;
let currentGameAddress = "";
let currentMushAddress = "";

// small helpers
function log(msg){ const el=document.getElementById('logArea'); el.innerText = new Date().toISOString() + " | " + msg + "\n" + el.innerText; }
function toast(msg){ const t=document.getElementById('toast'); t.textContent=msg; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,2200); }
function toEth(wei){ try{ return ethers.utils.formatEther(wei); }catch(e){return '0';} }
function fromEth(eth){ return ethers.utils.parseEther(String(eth)); }

// compute a friendly referral code from an address (fallback if contract not returning one)
function computeReferralFromAddr(addr){
  if(!addr) return '';
  const clean = addr.replace(/^0x/i,'').toUpperCase();
  const part = clean.slice(2,8); // 6 hex chars
  return ('RF-' + part.slice(0,2) + '-' + part.slice(2,4)).slice(0,6+3); // keeps format RF-XX-XX
}

// connect wallet
async function connectWallet(){
  if(!window.ethereum) { alert('Install MetaMask or other EVM wallet'); return; }
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddr = await signer.getAddress();
  document.getElementById('addrDisplay').textContent = userAddr;
  document.getElementById('contractAddress').value = GAME_CONTRACT_ADDRESS || '';
  document.getElementById('mushAddress').value = MUSH_TOKEN_ADDRESS || '';
  document.getElementById('treasuryAddr').textContent = TREASURY_ADDRESS;
  const network = await provider.getNetwork();
  document.getElementById('networkName').textContent = network.name + ' ('+network.chainId +')';
  document.getElementById('connectBtn').textContent = 'Connected';
  document.getElementById('connectBtn').disabled = true;
  document.getElementById('copyAddrBtn').disabled = false;
  // display computed ref
  const rc = computeReferralFromAddr(userAddr);
  document.getElementById('refCodeLocal').textContent = rc;
  document.getElementById('registerBtn').disabled = false;
  document.getElementById('claimBtn').disabled = false;
  document.getElementById('upgradeBtn').disabled = false;
  document.getElementById('swapBtn').disabled = false;
  // create game contract instance if addresses provided
  tryInitContract();
  // auto refresh player data
  await refreshPlayerData();
  log('Wallet connected: ' + userAddr);
}

// init contract
function tryInitContract(){
  const gameAddr = document.getElementById('contractAddress').value.trim();
  const mushAddr = document.getElementById('mushAddress').value.trim();
  if(!provider || !gameAddr) return;
  if(currentGameAddress === gameAddr) return;
  currentGameAddress = gameAddr;
  currentMushAddress = mushAddr;
  gameContract = new ethers.Contract(gameAddr, GAME_ABI, signer || provider);
  log('Game contract initialized: ' + gameAddr);
  // listen to PackOpened (if available)
  try {
    gameContract.on && gameContract.on('PackOpened', (player, packId, itemId, ev) => {
      log(`PackOpened: player=${player} pack=${packId} item=${itemId}`);
      if(player && player.toLowerCase() === userAddr.toLowerCase()) refreshPlayerData();
    });
  } catch(e){ /* ignore */ }
}

// register (calls payable register(bytes6))
async function registerPlayer(){
  if(!gameContract) { alert('Set game contract address first'); return; }
  const raw = document.getElementById('refInput').value.trim();
  // ensure bytes6 encoded value. We'll accept either hex bytes6 like 0x1234.. or string code and encode as bytes6.
  let refBytes = '0x000000000000';
  if(raw){
    // take first 6 characters ASCII (padded)
    const b = ethers.utils.toUtf8Bytes(raw);
    const padded = ethers.utils.hexZeroPad(ethers.utils.hexlify(b.slice(0,6)), 6);
    refBytes = padded;
  } else {
    // use computed ref code derived from address (frontend fallback)
    const code = computeReferralFromAddr(userAddr);
    const b = ethers.utils.toUtf8Bytes(code);
    refBytes = ethers.utils.hexZeroPad(ethers.utils.hexlify(b.slice(0,6)), 6);
  }
  // call register payable. We don't know required fee from contract here; default we'll send 0.005 ETH (safe fallback)
  const fee = fromEth('0.005'); // adjust if your contract uses different value
  try{
    const tx = await gameContract.register(refBytes, { value: fee });
    toast('Register tx sent — waiting for confirmation');
    log('register tx: ' + tx.hash);
    await tx.wait();
    toast('Registered on-chain');
    await refreshPlayerData();
  } catch(e){
    console.error(e); toast('Register failed: ' + (e?.message || e));
  }
}

// claim rewards
async function claimRewards(){
  if(!gameContract) { alert('set game contract'); return; }
  try{
    const tx = await gameContract.claim();
    toast('Claim tx sent');
    log('claim tx: ' + tx.hash);
    await tx.wait();
    toast('Claim completed');
    await refreshPlayerData();
  }catch(e){ console.error(e); toast('Claim failed: '+(e?.message||e)); }
}

// upgrade farm (simple single-step)
async function upgradeFarm(){
  if(!gameContract) { alert('set game contract'); return; }
  // default pay 0.01 ETH for upgrade (adjust to match on-chain)
  const cost = fromEth('0.01');
  try{
    const tx = await gameContract.upgrade(1, { value: cost });
    toast('Upgrade tx sent');
    log('upgrade tx: ' + tx.hash);
    await tx.wait();
    toast('Upgrade done');
    await refreshPlayerData();
  }catch(e){ console.error(e); toast('Upgrade failed: '+(e?.message||e)); }
}

// open pack
async function openPack(packId){
  if(!gameContract) { alert('set game contract'); return; }
  let priceEth = '0.01';
  if(packId === 2) priceEth = '0.05';
  const value = fromEth(priceEth);
  try{
    const tx = await gameContract.openPack(packId, { value });
    toast('Open pack tx sent');
    log('openPack tx: ' + tx.hash);
    await tx.wait();
    toast('Pack opened');
    await refreshPlayerData();
  }catch(e){ console.error(e); toast('Open pack failed: '+(e?.message||e)); }
}

// swap MON -> MUSH
async function swapMonForMush(){
  if(!gameContract) { alert('set game contract'); return; }
  // default swap amount 0.01 ETH
  const val = fromEth('0.01');
  try{
    const tx = await gameContract.swapMonForMush({ value: val });
    toast('Swap tx sent');
    log('swap tx: ' + tx.hash);
    await tx.wait();
    toast('Swap done');
    await refreshPlayerData();
  }catch(e){ console.error(e); toast('Swap failed: '+(e?.message||e)); }
}

// refresh player data (calls several view functions if available)
async function refreshPlayerData(){
  if(!provider || !userAddr) return;
  if(!gameContract){
    document.getElementById('playerPower').textContent='—';
    document.getElementById('pendingRewards').textContent='—';
    document.getElementById('playerLevel').textContent='—';
    return;
  }
  try{
    // try different view functions; graceful failures handled
    let power='—', pending='—', lvl='—';
    try{ const p = await gameContract.getPlayerPower(userAddr); power = Number(ethers.utils.formatEther(p)); }catch(err){}
    try{ const pend = await gameContract.pendingRewards(userAddr); pending = Number(ethers.utils.formatEther(pend)); }catch(err){}
    try{ const l = await gameContract.getPlayerLevel(userAddr); lvl = l.toString(); }catch(err){}
    document.getElementById('playerPower').textContent = power;
    document.getElementById('pendingRewards').textContent = pending;
    document.getElementById('playerLevel').textContent = lvl;
  }catch(e){
    console.error(e);
  }

  // inventory
  try{
    const inv = await gameContract.getInventory(userAddr);
    const tbody = document.getElementById('invBody');
    tbody.innerHTML = '';
    if(inv && inv.length){
      for(let i=0;i<inv.length;i++){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>#${inv[i].toString()}</td><td>—</td><td>—</td>`;
        tbody.appendChild(tr);
      }
    } else {
      tbody.innerHTML = `<tr><td colspan="3" class="muted center">No items</td></tr>`;
    }
  }catch(err){
    // couldn't fetch inventory
    const tbody = document.getElementById('invBody');
    tbody.innerHTML = `<tr><td colspan="3" class="muted center">Inventory not available</td></tr>`;
  }
}

// ---------------- Event bindings ----------------
document.getElementById('connectBtn').addEventListener('click', connectWallet);
document.getElementById('refreshBtn').addEventListener('click', async ()=>{ tryInitContract(); await refreshPlayerData(); toast('Refreshed'); });
document.getElementById('setAddresses').addEventListener('click', ()=>{ tryInitContract(); toast('Using addresses'); });
document.getElementById('registerBtn').addEventListener('click', registerPlayer);
document.getElementById('claimBtn').addEventListener('click', claimRewards);
document.getElementById('upgradeBtn').addEventListener('click', upgradeFarm);
document.getElementById('openBasic').addEventListener('click', ()=>openPack(1));
document.getElementById('openPremium').addEventListener('click', ()=>openPack(2));
document.getElementById('swapBtn').addEventListener('click', swapMonForMush);
document.getElementById('applyRef').addEventListener('click', ()=>{
  const v = document.getElementById('refInput').value.trim();
  if(!v) toast('Empty: will use your computed referral when registering');
  else toast('Referral set: ' + v);
});
document.getElementById('showCodeBtn').addEventListener('click', ()=>{
  if(!userAddr) return toast('Connect wallet first');
  const code = computeReferralFromAddr(userAddr);
  toast('Ref code (computed): ' + code);
  log('Computed ref: ' + code);
});
document.getElementById('copyAddrBtn').addEventListener('click', async ()=>{
  if(!userAddr) return toast('Connect first');
  await navigator.clipboard.writeText(userAddr);
  toast('Address copied');
});

// set initial treasury UI
document.getElementById('treasuryAddr').textContent = TREASURY_ADDRESS;

// when user edits addresses, update local contract instance
document.getElementById('contractAddress').addEventListener('change', tryInitContract);
document.getElementById('mushAddress').addEventListener('change', tryInitContract);

// on page load: preload contract address if config has them
window.addEventListener('load', ()=>{
  if(GAME_CONTRACT_ADDRESS) document.getElementById('contractAddress').value = GAME_CONTRACT_ADDRESS;
  if(MUSH_TOKEN_ADDRESS) document.getElementById('mushAddress').value = MUSH_TOKEN_ADDRESS;
  // small UX: if injected wallet already connected, auto-read accounts
  if(window.ethereum && window.ethereum.selectedAddress){
    connectWallet().catch(()=>{});
  }
});
</script>
</body>
</html>
